'use client';

import { useEffect, useCallback, useRef, useState } from 'react';

const AlkiSecretLinks = () => {
  const [discoveredSecrets, setDiscoveredSecrets] = useState<Set<string>>(new Set());
  const [showSecretMenu, setShowSecretMenu] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const lastClickRef = useRef<number>(0);

  // Track analytics
  const trackEvent = useCallback((eventName: string, secretId?: string) => {
    if (typeof window !== 'undefined' && (window as any).gtag) {
      (window as any).gtag('event', 'alki_secret_discovered', {
        event_category: 'secret_engagement',
        event_label: eventName,
        secret_id: secretId || 'unknown',
        non_interaction: true
      });
    }
  }, []);

  // Play secret audio
  const playSecretAudio = useCallback((trackUrl: string, secretId: string) => {
    const now = Date.now();
    if (now - lastClickRef.current < 500) return;
    lastClickRef.current = now;

    if (audioRef.current) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
      audioRef.current.src = trackUrl;
      audioRef.current.volume = 0.6;
      audioRef.current.load();
      
      const playPromise = audioRef.current.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            console.log('Secret audio playing:', secretId);
            setDiscoveredSecrets(prev => {
              const newSet = new Set(prev);
              newSet.add(secretId);
              return newSet;
            });
            trackEvent('secret_audio_played', secretId);
            showDiscoveryNotification(secretId);
          })
          .catch(err => {
            console.error('Secret audio playback failed:', err);
          });
      }
    }
  }, [trackEvent]);

  // Show URL popup
  const showURLPopup = useCallback((url: string, title: string, secretId: string) => {
    setDiscoveredSecrets(prev => {
      const newSet = new Set(prev);
      newSet.add(secretId);
      return newSet;
    });
    trackEvent('url_secret_discovered', secretId);

    const popup = document.createElement('div');
    popup.innerHTML = `
      <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
        <div style="font-size: 32px;">ğŸ”—</div>
        <div style="font-weight: bold; font-size: 18px;">${title}</div>
        <a href="${url}" target="_blank" rel="noopener noreferrer" 
           style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); 
                  padding: 10px 20px; border-radius: 8px; transition: all 0.2s;"
           onmouseover="this.style.background='rgba(255,255,255,0.3)'"
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
          Visit Now â†’
        </a>
      </div>
    `;
    popup.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      z-index: 10002;
      animation: scaleIn 0.3s ease-out, fadeOut 0.3s ease-out 4.7s forwards;
      font-family: system-ui, -apple-system, sans-serif;
      text-align: center;
    `;
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 5000);
  }, [trackEvent]);

  // Show discovery notification
  const showDiscoveryNotification = useCallback((secretId: string) => {
    const notification = document.createElement('div');
    notification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">ğŸµ</span>
        <div>
          <div style="font-weight: bold;">Secret Discovered!</div>
          <div style="font-size: 12px; opacity: 0.8;">You found an Alki track!</div>
        </div>
      </div>
    `;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 10000;
      animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
      font-family: system-ui, -apple-system, sans-serif;
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }, []);

  // Create invisible clickable zones
  useEffect(() => {
    // Secret zone 1: Top-left corner (triple click) - 5D
    let cornerClicks = 0;
    let cornerTimeout: NodeJS.Timeout;

    const handleCornerClick = (e: MouseEvent) => {
      if (e.clientX < 50 && e.clientY < 50) {
        cornerClicks++;
        clearTimeout(cornerTimeout);
        
        if (cornerClicks === 3) {
          playSecretAudio('/audio/alki/5d.mp3', 'corner_secret');
          cornerClicks = 0;
        } else {
          cornerTimeout = setTimeout(() => {
            cornerClicks = 0;
          }, 1000);
        }
      }
    };

    // Secret zone 2: Bottom-right corner (double click) - Bad One
    let bottomClicks = 0;
    let bottomTimeout: NodeJS.Timeout;

    const handleBottomClick = (e: MouseEvent) => {
      const isBottomRight = e.clientX > window.innerWidth - 50 && e.clientY > window.innerHeight - 50;
      
      if (isBottomRight) {
        bottomClicks++;
        clearTimeout(bottomTimeout);
        
        if (bottomClicks === 2) {
          playSecretAudio('/audio/alki/bad-one.mp3', 'bottom_secret');
          bottomClicks = 0;
        } else {
          bottomTimeout = setTimeout(() => {
            bottomClicks = 0;
          }, 1000);
        }
      }
    };

    // Secret: Hold Shift and click anywhere 5 times - Death Of Me
    let shiftClicks = 0;
    let shiftTimeout: NodeJS.Timeout;

    const handleShiftClick = (e: MouseEvent) => {
      if (e.shiftKey) {
        shiftClicks++;
        clearTimeout(shiftTimeout);
        
        if (shiftClicks === 5) {
          playSecretAudio('/audio/alki/death-of-me.mp3', 'shift_secret');
          shiftClicks = 0;
        } else {
          shiftTimeout = setTimeout(() => {
            shiftClicks = 0;
          }, 2000);
        }
      }
    };

    // Secret: Ctrl+Shift+A - Home (Alone)
    const handleKeyCombo = (e: KeyboardEvent) => {
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a') {
        e.preventDefault();
        playSecretAudio('/audio/alki/home-alone.mp3', 'keyboard_secret');
      }

      // Secret menu toggle
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'm') {
        e.preventDefault();
        setShowSecretMenu(prev => !prev);
        trackEvent('secret_menu_toggled');
      }

      // Secret: Ctrl+Shift+U - Grouped URL
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'u') {
        e.preventDefault();
        showURLPopup('https://app.grouped.com/everythingalki', 'Everything Alki on Grouped', 'grouped_url_secret');
      }

      // Secret: Ctrl+Shift+I - Instagram URL
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') {
        e.preventDefault();
        showURLPopup('https://instagram.com/alkiotis', 'Follow Alki on Instagram', 'instagram_url_secret');
      }
    };

    // Secret: Scroll to exact middle of page and wait 3 seconds - Home
    let scrollTimeout: NodeJS.Timeout;
    const handleScroll = () => {
      clearTimeout(scrollTimeout);
      
      const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
      
      if (scrollPercent >= 49 && scrollPercent <= 51) {
        scrollTimeout = setTimeout(() => {
          if (!discoveredSecrets.has('scroll_middle_secret')) {
            playSecretAudio('/audio/alki/home.mp3', 'scroll_middle_secret');
          }
        }, 3000);
      }
    };

    // Secret: Top-right corner (quadruple click) - Grouped URL
    let topRightClicks = 0;
    let topRightTimeout: NodeJS.Timeout;

    const handleTopRightClick = (e: MouseEvent) => {
      const isTopRight = e.clientX > window.innerWidth - 50 && e.clientY < 50;
      
      if (isTopRight) {
        topRightClicks++;
        clearTimeout(topRightTimeout);
        
        if (topRightClicks === 4) {
          showURLPopup('https://app.grouped.com/everythingalki', 'Everything Alki on Grouped', 'top_right_secret');
          topRightClicks = 0;
        } else {
          topRightTimeout = setTimeout(() => {
            topRightClicks = 0;
          }, 1000);
        }
      }
    };

    // Secret: Bottom-left corner (quadruple click) - Instagram URL
    let bottomLeftClicks = 0;
    let bottomLeftTimeout: NodeJS.Timeout;

    const handleBottomLeftClick = (e: MouseEvent) => {
      const isBottomLeft = e.clientX < 50 && e.clientY > window.innerHeight - 50;
      
      if (isBottomLeft) {
        bottomLeftClicks++;
        clearTimeout(bottomLeftTimeout);
        
        if (bottomLeftClicks === 4) {
          showURLPopup('https://instagram.com/alkiotis', 'Follow Alki on Instagram', 'bottom_left_secret');
          bottomLeftClicks = 0;
        } else {
          bottomLeftTimeout = setTimeout(() => {
            bottomLeftClicks = 0;
          }, 1000);
        }
      }
    };

    document.addEventListener('click', handleCornerClick);
    document.addEventListener('click', handleBottomClick);
    document.addEventListener('click', handleShiftClick);
    document.addEventListener('click', handleTopRightClick);
    document.addEventListener('click', handleBottomLeftClick);
    document.addEventListener('keydown', handleKeyCombo);
    window.addEventListener('scroll', handleScroll, { passive: true });

    return () => {
      document.removeEventListener('click', handleCornerClick);
      document.removeEventListener('click', handleBottomClick);
      document.removeEventListener('click', handleShiftClick);
      document.removeEventListener('click', handleTopRightClick);
      document.removeEventListener('click', handleBottomLeftClick);
      document.removeEventListener('keydown', handleKeyCombo);
      window.removeEventListener('scroll', handleScroll);
      clearTimeout(cornerTimeout);
      clearTimeout(bottomTimeout);
      clearTimeout(shiftTimeout);
      clearTimeout(scrollTimeout);
      clearTimeout(topRightTimeout);
      clearTimeout(bottomLeftTimeout);
    };
  }, [playSecretAudio, discoveredSecrets, trackEvent, showURLPopup]);

  // Create hidden text links in the page
  useEffect(() => {
    const addSecretTriggers = () => {
      const musicElements = document.querySelectorAll('p, h1, h2, h3, h4, h5, h6, span, div');
      
      musicElements.forEach(element => {
        // Double-click "music" word - Okay
        if (element.textContent?.toLowerCase().includes('music')) {
          const handler = () => {
            playSecretAudio('/audio/alki/okay.mp3', 'music_word_secret');
          };
          element.addEventListener('dblclick', handler);
        }

        // Double-click "artist" word - Luv 4
        if (element.textContent?.toLowerCase().includes('artist')) {
          const handler = () => {
            playSecretAudio('/audio/alki/luv4.mp3', 'artist_word_secret');
          };
          element.addEventListener('dblclick', handler);
        }

        // Double-click "record" word - Stay
        if (element.textContent?.toLowerCase().includes('record')) {
          const handler = () => {
            playSecretAudio('/audio/alki/stay.mp3', 'record_word_secret');
          };
          element.addEventListener('dblclick', handler);
        }

        // Double-click "label" word - Take It All Away
        if (element.textContent?.toLowerCase().includes('label')) {
          const handler = () => {
            playSecretAudio('/audio/alki/take-it-all-away.mp3', 'label_word_secret');
          };
          element.addEventListener('dblclick', handler);
        }

        // Double-click "sound" word - Tear Me Apart
        if (element.textContent?.toLowerCase().includes('sound')) {
          const handler = () => {
            playSecretAudio('/audio/alki/tear-me-apart.mp3', 'sound_word_secret');
          };
          element.addEventListener('dblclick', handler);
        }
      });
    };

    const timeout = setTimeout(addSecretTriggers, 1000);
    return () => clearTimeout(timeout);
  }, [playSecretAudio]);

  return (
    <>
      <audio 
        ref={audioRef}
        preload="none"
        onError={(e) => {
          console.error('Secret audio error:', e);
        }}
      />

      {/* Secret Menu */}
      {showSecretMenu && (
        <div
          style={{
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
            border: '2px solid #667eea',
            borderRadius: '20px',
            padding: '30px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.5)',
            zIndex: 10001,
            color: 'white',
            fontFamily: 'system-ui, -apple-system, sans-serif',
            maxWidth: '600px',
            maxHeight: '85vh',
            overflowY: 'auto',
            animation: 'scaleIn 0.3s ease-out',
          }}
        >
          <button
            onClick={() => setShowSecretMenu(false)}
            style={{
              position: 'absolute',
              top: '15px',
              right: '15px',
              background: 'rgba(255,255,255,0.1)',
              border: 'none',
              borderRadius: '50%',
              width: '35px',
              height: '35px',
              cursor: 'pointer',
              color: 'white',
              fontSize: '20px',
            }}
          >
            Ã—
          </button>

          <h2 style={{ fontSize: '24px', marginBottom: '20px', textAlign: 'center' }}>
            ğŸµ Alki's Secret Vault ğŸµ
          </h2>

          <p style={{ fontSize: '14px', opacity: 0.8, marginBottom: '20px', textAlign: 'center' }}>
            Discover hidden music and exclusive links!
          </p>

          <div style={{ marginBottom: '20px' }}>
            <h3 style={{ fontSize: '16px', marginBottom: '10px' }}>Discovered Secrets:</h3>
            <div style={{ fontSize: '14px', opacity: 0.9 }}>
              {discoveredSecrets.size === 0 ? (
                <p style={{ opacity: 0.6 }}>No secrets discovered yet...</p>
              ) : (
                <ul style={{ listStyle: 'none', padding: 0 }}>
                  {(() => {
                    const secretsArray: string[] = [];
                    discoveredSecrets.forEach(secret => secretsArray.push(secret));
                    return secretsArray.map(secret => (
                      <li key={secret} style={{ padding: '5px 0', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                        âœ“ {secret.replace(/_/g, ' ').toUpperCase()}
                      </li>
                    ));
                  })()}
                </ul>
              )}
            </div>
          </div>

          <div style={{ background: 'rgba(255,255,255,0.05)', padding: '15px', borderRadius: '10px', marginBottom: '15px' }}>
            <h3 style={{ fontSize: '14px', marginBottom: '10px', opacity: 0.8' }}>ğŸµ Music Secret Locations:</h3>
            <ul style={{ fontSize: '12px', opacity: 0.7, lineHeight: '1.8', paddingLeft: '20px' }}>
              <li>Triple-click top-left corner â†’ 5D</li>
              <li>Double-click bottom-right corner â†’ Bad One</li>
              <li>Hold Shift + click 5 times â†’ Death Of Me</li>
              <li>Press Ctrl+Shift+A â†’ Home (Alone)</li>
              <li>Scroll to middle and wait 3s â†’ Home</li>
              <li>Double-click "music" word â†’ Okay</li>
              <li>Double-click "artist" word â†’ Luv 4</li>
              <li>Double-click "record" word â†’ Stay</li>
              <li>Double-click "label" word â†’ Take It All Away</li>
              <li>Double-click "sound" word â†’ Tear Me Apart</li>
            </ul>
          </div>

          <div style={{ background: 'rgba(255,255,255,0.05)', padding: '15px', borderRadius: '10px', marginBottom: '15px' }}>
            <h3 style={{ fontSize: '14px', marginBottom: '10px', opacity: 0.8' }}>ğŸ”— URL Secret Locations:</h3>
            <ul style={{ fontSize: '12px', opacity: 0.7, lineHeight: '1.8', paddingLeft: '20px' }}>
              <li>Quadruple-click top-right corner â†’ Grouped</li>
              <li>Quadruple-click bottom-left corner â†’ Instagram</li>
              <li>Press Ctrl+Shift+U â†’ Grouped</li>
              <li>Press Ctrl+Shift+I â†’ Instagram</li>
              <li>Type "grouped" anywhere â†’ Grouped</li>
              <li>Type "instagram" or "insta" â†’ Instagram</li>
            </ul>
          </div>

          <div style={{ background: 'rgba(255,255,255,0.05)', padding: '15px', borderRadius: '10px' }}>
            <h3 style={{ fontSize: '14px', marginBottom: '10px', opacity: 0.8' }}>âŒ¨ï¸ Type Triggers (All 14 Tracks):</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '5px', fontSize: '11px', opacity: 0.7' }}>
              <div>â€¢ alki â†’ Player</div>
              <div>â€¢ iptwha â†’ IPTWHA</div>
              <div>â€¢ likethat â†’ Like That</div>
              <div>â€¢ wrongs â†’ Writin' My Wrongs</div>
              <div>â€¢ regrets â†’ Regrets</div>
              <div>â€¢ home â†’ Home</div>
              <div>â€¢ okay â†’ Okay</div>
              <div>â€¢ luv4 â†’ Luv 4</div>
              <div>â€¢ stay â†’ Stay</div>
              <div>â€¢ takeaway â†’ Take It All Away</div>
              <div>â€¢ tearme â†’ Tear Me Apart</div>
              <div>â€¢ 5d â†’ 5D</div>
              <div>â€¢ badone â†’ Bad One</div>
              <div>â€¢ deathofme â†’ Death Of Me</div>
              <div>â€¢ homealone â†’ Home (Alone)</div>
            </div>
          </div>

          <div style={{ marginTop: '20px', textAlign: 'center', fontSize: '12px', opacity: 0.6' }}>
            Progress: {discoveredSecrets.size} / 16 secrets found
            <br />
            (10 music + 6 URL secrets)
          </div>
        </div>
      )}

      {/* Corner indicators */}
      <div
        style={{
          position: 'fixed',
          top: '10px',
          left: '10px',
          width: '30px',
          height: '30px',
          opacity: discoveredSecrets.has('corner_secret') ? 0.5 : 0.1,
          background: 'radial-gradient(circle, #667eea 0%, transparent 70%)',
          pointerEvents: 'none',
          zIndex: 9997,
          transition: 'opacity 0.3s',
        }}
      />

      <div
        style={{
          position: 'fixed',
          bottom: '10px',
          right: '10px',
          width: '30px',
          height: '30px',
          opacity: discoveredSecrets.has('bottom_secret') ? 0.5 : 0.1,
          background: 'radial-gradient(circle, #764ba2 0%, transparent 70%)',
          pointerEvents: 'none',
          zIndex: 9997,
          transition: 'opacity 0.3s',
        }}
      />

      <div
        style={{
          position: 'fixed',
          top: '10px',
          right: '10px',
          width: '30px',
          height: '30px',
          opacity: discoveredSecrets.has('top_right_secret') ? 0.5 : 0.1,
          background: 'radial-gradient(circle, #6BCB77 0%, transparent 70%)',
          pointerEvents: 'none',
          zIndex: 9997,
          transition: 'opacity 0.3s',
        }}
      />

      <div
        style={{
          position: 'fixed',
          bottom: '10px',
          left: '10px',
          width: '30px',
          height: '30px',
          opacity: discoveredSecrets.has('bottom_left_secret') ? 0.5 : 0.1,
          background: 'radial-gradient(circle, #FF6B9D 0%, transparent 70%)',
          pointerEvents: 'none',
          zIndex: 9997,
          transition: 'opacity 0.3s',
        }}
      />

      {/* Animations */}
      <style jsx>{`
        @keyframes scaleIn {
          from {
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
          }
          to {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
          }
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes fadeOut {
          to {
            opacity: 0;
            transform: translateX(100%);
          }
        }
      `}</style>
    </>
  );
};

export default AlkiSecretLinks;